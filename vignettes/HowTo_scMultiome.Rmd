---
title: "HowTo_scMultiome"
author: "Giovanni Gavatorta"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{HowTo_scMultiome}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r echo = FALSE, warning = FALSE, message = FALSE}
suppressMessages(library(scMultiome))
suppressMessages(library(Matrix))
suppressMessages(library(GenomicRanges))
suppressMessages(library(data.table))
suppressMessages(library(dplyr)) 
suppressMessages(library(tidyr)) 
suppressMessages(library(ggplot2))
```

# Introduction

**scMultiome** is an R package designed to simplify the integration and visualization of single-cell multi-omics data, including ATAC-seq and gene expression from the same cells. This vignette demonstrates the primary workflow from raw data processing to visualization.

------------------------------------------------------------------------

# Data processing and analysis

## Matrix conversion

Use `ConvertMatrix` to convert the sparse matrix into a full matrix and save the result as a `data.table` object, which is the input for the rest of the pipeline.

```{r}
expr_dt <- ConvertMatrix(
  mtx_path = system.file("extdata/expression/matrix.mtx.gz", package = "scMultiome"),
  features_path = system.file("extdata/expression/features.tsv.gz", package = "scMultiome"),
  barcodes_path = system.file("extdata/expression/barcodes.tsv.gz", package = "scMultiome")
)
knitr::kable(head(expr_dt))
```

## Split gene expression and ATAC-seq data

Use `SplitGeneAndAtac` to split the full `data.table` created in the step before into two separate tables: one for gene expression (rows starting with "ENSG") and one for ATAC-seq peaks (rows starting with "chr").

```{r}
split_data <- SplitGeneAndAtac(expr_dt)
gene_expr_dt <- split_data$gene_expr
atac_peaks_dt <- split_data$atac_peaks

knitr::kable(head(gene_expr_dt))
knitr::kable(head(atac_peaks_dt))
```

## Summarize data

Use `SummarizeData` to compute the total counts per cell by summing across rows (genes or peaks) in both gene expression and ATAC-seq peak `data.table`s.

```{r}
sum_data <- SummarizeData(gene_expr_dt, atac_peaks_dt)
knitr::kable(head(sum_data$gene_totals))
knitr::kable(head(sum_data$atac_totals))
```

## Create Genomic Ranges

First, use `CreateGRangeObj` to convert a data.frame of genomic features and metadata into a `GRanges` object. It is typically used to convert ATAC-seq peaks or gene expression features into genomic ranges.

```{r}
df <- fread(system.file("extdata/expression/features.tsv.gz", package = "scMultiome"), header = FALSE)
gr <- CreateGRangeObj(specific_feature = df, feature_id = "Expr")
```

Then, use `PrepareGRanges` to processes summarized expression or ATAC-seq data by computing row sums and merging them with genomic coordinates from a features annotation file, before converting them into a `GRanges` object.

```{r}
features <- fread(system.file("extdata/expression/features.tsv.gz", package = "scMultiome"), header = FALSE)
expr_gr <- PrepareGRanges(gene_expr_dt, features, feature_id = "Expr")
atac_gr <- PrepareGRanges(atac_peaks_dt, features, feature_id = "ATAC")
```

## Gene annotation for ATAC-seq data

Use `AnnotateATACwithGenes` to reads a GTF annotation file, filters for protein-coding genes, and then finds overlaps between ATAC-seq peaks and these genes. It returns a `GRanges` object of ATAC peaks annotated with gene information.

```{r}
gtf_path <- system.file("extdata/Homo_sapiens.GRCh38.114.gtf.gz", package = "scMultiome")
annotated_atac <- AnnotateATACwithGenes(gtf_path, atac_gr)
```

## Finalize Expression Data with Protein-Coding Genes

Use `CreateProteinCodingGR` to import a GTF annotation file and filters it to keep only features of type "gene" that are protein-coding. The output is a GRanges object ready for downstream overlap analysis.

And then use `FinalizeExpressionData` to take a GRanges object of expression data and filters it to retain only those entries that correspond to protein-coding genes (based on GTF annotation). It also adds gene symbol names as a metadata column for easier interpretation.

```{r}
protein_coding_gr <- CreateProteinCodingGR(gtf_path)
expr_filtered_gr <- FinalizeExpressionData(expr_gr, protein_coding_gr)
```

## Normalize and integrate datasets

Use `NormalizeAndIntegrate` to performs normalization of gene expression and ATAC-seq counts using CPM (Counts Per Million), merges them based on shared gene IDs, and generates summary boxplots for quality control by chromosome.

```{r}
integration_results <- NormalizeAndIntegrate(expr_filtered_gr, annotated_atac)
knitr::kable(head(integration_results$merged_table))
```

## Plot Expression vs ATAC-seq CPM

Use `PlotExprVsATAC` to  generates scatter plots to visualize the relationship between log2-transformed CPM-normalized gene expression and ATAC-seq signals. If the dataset is too large, it creates separate plots for each chromosome.

```{r}
scatter_plots <- PlotExprVsATAC(integration_results$merged_table, expr_filtered_gr)

# Display plots
if (inherits(scatter_plots, "ggplot")) {
  print(scatter_plots)
} else {
  lapply(scatter_plots, print)
}
```

---

# Session Info

```{r}
sessionInfo()
